<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†å›¾è°± - Yuki Bot</title>
    <link rel="stylesheet" href="/admin/static/css/common.css">
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .header .subtitle {
            margin-top: 5px;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .controls-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-group label {
            font-weight: 500;
            color: #333;
        }
        
        .control-group input,
        .control-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .graph-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #graph {
            width: 100%;
            height: 600px;
            border: 1px solid #e0e0e0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-card .label {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }
        
        .node-details {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
            display: none;
        }
        
        .node-details.active {
            display: block;
        }
        
        .node-details h3 {
            margin-top: 0;
            color: #333;
        }
        
        .node-details .info-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .node-details .info-row:last-child {
            border-bottom: none;
        }
        
        .node-details .info-label {
            font-weight: 500;
            color: #666;
            width: 120px;
        }
        
        .node-details .info-value {
            color: #333;
            flex: 1;
        }
        
        .relations-list {
            margin-top: 15px;
        }
        
        .relation-item {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ•¸ï¸ çŸ¥è¯†å›¾è°±å¯è§†åŒ–</h1>
        <div class="subtitle">RAG çŸ¥è¯†å›¾è°±ç®¡ç†ä¸å¯è§†åŒ–</div>
    </div>
    
    <div class="container">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats">
            <div class="stat-card">
                <div class="label">æ€»èŠ‚ç‚¹æ•°</div>
                <div class="value" id="totalNodes">-</div>
            </div>
            <div class="stat-card">
                <div class="label">æ€»å…³ç³»æ•°</div>
                <div class="value" id="totalEdges">-</div>
            </div>
            <div class="stat-card">
                <div class="label">ç”¨æˆ·æ•°</div>
                <div class="value" id="totalUsers">-</div>
            </div>
            <div class="stat-card">
                <div class="label">å®ä½“ç±»å‹</div>
                <div class="value" id="entityTypes">-</div>
            </div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div class="controls-row">
                <div class="control-group">
                    <label for="userSelect">ç”¨æˆ·:</label>
                    <select id="userSelect">
                        <option value="">å…¨éƒ¨ç”¨æˆ·</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="entityType">å®ä½“ç±»å‹:</label>
                    <select id="entityType">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                        <option value="äººç‰©">äººç‰©</option>
                        <option value="åœ°ç‚¹">åœ°ç‚¹</option>
                        <option value="ç‰©å“">ç‰©å“</option>
                        <option value="äº‹ä»¶">äº‹ä»¶</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="searchInput">æœç´¢:</label>
                    <input type="text" id="searchInput" placeholder="æœç´¢å®ä½“åç§°...">
                </div>
                
                <button class="btn btn-primary" onclick="loadGraph()">ğŸ”„ åˆ·æ–°</button>
                <button class="btn btn-secondary" onclick="resetView()">ğŸ¯ é‡ç½®è§†å›¾</button>
                <button class="btn btn-danger" onclick="clearGraph()">ğŸ—‘ï¸ æ¸…ç©ºå›¾è°±</button>
            </div>
        </div>
        
        <!-- å›¾è°±å®¹å™¨ -->
        <div class="graph-container">
            <div id="graph"></div>
        </div>
        
        <!-- èŠ‚ç‚¹è¯¦æƒ… -->
        <div class="node-details" id="nodeDetails">
            <h3>èŠ‚ç‚¹è¯¦æƒ…</h3>
            <div class="info-row">
                <div class="info-label">å®ä½“åç§°:</div>
                <div class="info-value" id="detailEntity">-</div>
            </div>
            <div class="info-row">
                <div class="info-label">å®ä½“ç±»å‹:</div>
                <div class="info-value" id="detailType">-</div>
            </div>
            <div class="info-row">
                <div class="info-label">ç”¨æˆ·ID:</div>
                <div class="info-value" id="detailUser">-</div>
            </div>
            <div class="info-row">
                <div class="info-label">åˆ›å»ºæ—¶é—´:</div>
                <div class="info-value" id="detailTime">-</div>
            </div>
            
            <h4 style="margin-top: 20px;">å…³è”å…³ç³»</h4>
            <div class="relations-list" id="relationsList"></div>
        </div>
    </div>
    
    <script>
        let network = null;
        let nodes = null;
        let edges = null;
        let allData = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            loadStats();
            loadGraph();
        });
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                const response = await fetch('/admin/api/graph/users');
                const result = await response.json();
                
                if (result.success) {
                    const select = document.getElementById('userSelect');
                    result.data.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.user_id;
                        option.textContent = `${user.user_id} (${user.node_count} èŠ‚ç‚¹)`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const response = await fetch('/admin/api/graph/stats');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('totalNodes').textContent = result.data.total_nodes;
                    document.getElementById('totalEdges').textContent = result.data.total_edges;
                    document.getElementById('totalUsers').textContent = result.data.total_users;
                    document.getElementById('entityTypes').textContent = result.data.entity_types;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å›¾è°±æ•°æ®
        async function loadGraph() {
            const userId = document.getElementById('userSelect').value;
            const entityType = document.getElementById('entityType').value;
            const search = document.getElementById('searchInput').value;
            
            try {
                const params = new URLSearchParams();
                if (userId) params.append('user_id', userId);
                if (entityType) params.append('entity_type', entityType);
                if (search) params.append('search', search);
                
                const response = await fetch(`/admin/api/graph/data?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    allData = result.data;
                    renderGraph(result.data);
                    loadStats();
                } else {
                    alert('åŠ è½½å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('åŠ è½½å›¾è°±å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // æ¸²æŸ“å›¾è°±
        function renderGraph(data) {
            const container = document.getElementById('graph');
            
            // å‡†å¤‡èŠ‚ç‚¹æ•°æ®
            const nodesArray = data.nodes.map(node => ({
                id: node.id,
                label: node.entity,
                title: `${node.entity}\nç±»å‹: ${node.entity_type}\nç”¨æˆ·: ${node.user_id}`,
                color: getNodeColor(node.entity_type),
                font: { size: 14 },
                data: node
            }));
            
            // å‡†å¤‡è¾¹æ•°æ®
            const edgesArray = data.edges.map(edge => ({
                from: edge.source_id,
                to: edge.target_id,
                label: edge.relation,
                arrows: 'to',
                font: { size: 12, align: 'middle' },
                data: edge
            }));
            
            nodes = new vis.DataSet(nodesArray);
            edges = new vis.DataSet(edgesArray);
            
            const graphData = {
                nodes: nodes,
                edges: edges
            };
            
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 20,
                    font: {
                        size: 14,
                        color: '#333'
                    },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    width: 2,
                    color: { color: '#848484', highlight: '#667eea' },
                    smooth: {
                        type: 'continuous'
                    },
                    font: {
                        size: 12,
                        align: 'middle',
                        background: 'white'
                    }
                },
                physics: {
                    enabled: true,
                    barnesHut: {
                        gravitationalConstant: -2000,
                        centralGravity: 0.3,
                        springLength: 150,
                        springConstant: 0.04
                    },
                    stabilization: {
                        iterations: 150
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200
                }
            };
            
            network = new vis.Network(container, graphData, options);
            
            // ç‚¹å‡»èŠ‚ç‚¹æ˜¾ç¤ºè¯¦æƒ…
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const node = nodes.get(nodeId);
                    showNodeDetails(node.data);
                }
            });
        }
        
        // è·å–èŠ‚ç‚¹é¢œè‰²
        function getNodeColor(entityType) {
            const colors = {
                'äººç‰©': '#667eea',
                'åœ°ç‚¹': '#f093fb',
                'ç‰©å“': '#4facfe',
                'äº‹ä»¶': '#43e97b',
                'å…¶ä»–': '#fa709a'
            };
            return colors[entityType] || '#999';
        }
        
        // æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…
        function showNodeDetails(node) {
            document.getElementById('detailEntity').textContent = node.entity;
            document.getElementById('detailType').textContent = node.entity_type;
            document.getElementById('detailUser').textContent = node.user_id;
            document.getElementById('detailTime').textContent = new Date(node.created_at * 1000).toLocaleString();
            
            // æ˜¾ç¤ºå…³è”å…³ç³»
            const relationsList = document.getElementById('relationsList');
            relationsList.innerHTML = '';
            
            const relations = allData.edges.filter(e => 
                e.source_id === node.id || e.target_id === node.id
            );
            
            if (relations.length === 0) {
                relationsList.innerHTML = '<div class="relation-item">æš‚æ— å…³è”å…³ç³»</div>';
            } else {
                relations.forEach(rel => {
                    const div = document.createElement('div');
                    div.className = 'relation-item';
                    
                    if (rel.source_id === node.id) {
                        const target = allData.nodes.find(n => n.id === rel.target_id);
                        div.textContent = `${node.entity} â†’ ${rel.relation} â†’ ${target.entity}`;
                    } else {
                        const source = allData.nodes.find(n => n.id === rel.source_id);
                        div.textContent = `${source.entity} â†’ ${rel.relation} â†’ ${node.entity}`;
                    }
                    
                    relationsList.appendChild(div);
                });
            }
            
            document.getElementById('nodeDetails').classList.add('active');
        }
        
        // é‡ç½®è§†å›¾
        function resetView() {
            if (network) {
                network.fit();
            }
        }
        
        // æ¸…ç©ºå›¾è°±
        async function clearGraph() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ•´ä¸ªçŸ¥è¯†å›¾è°±å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            const userId = document.getElementById('userSelect').value;
            
            try {
                const response = await fetch('/admin/api/graph/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId || null })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æ¸…ç©ºæˆåŠŸ');
                    loadGraph();
                } else {
                    alert('æ¸…ç©ºå¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('æ¸…ç©ºå¤±è´¥:', error);
                alert('æ¸…ç©ºå¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
