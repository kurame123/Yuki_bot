<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½æ„Ÿåº¦ç®¡ç† - Yuki Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #f472b6;
            --secondary: #fda4af;
            --accent: #60a5fa;
        }
        body {
            min-height: 100vh;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('/admin/static/images/yuki_bg.png');
            background-size: cover;
            background-position: center;
            filter: blur(3px);
            z-index: -1;
        }
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.3);
            z-index: -1;
        }
        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #f472b6, #fda4af);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .nav-link {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .nav-link:hover { background: rgba(244, 114, 182, 0.1); }
        .nav-link.active {
            background: linear-gradient(135deg, #f472b6, #fda4af);
            color: white;
        }
        .level-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .level--2 { background: #1f2937; color: #f3f4f6; } /* è®¨åŒ */
        .level--1 { background: #374151; color: #e5e7eb; } /* å·®åŠ² */
        .level-0 { background: #6b7280; color: #f9fafb; } /* ä¸èµ·çœ¼ */
        .level-1 { background: #9ca3af; color: #ffffff; } /* é™Œç”Ÿ */
        .level-2 { background: #dbeafe; color: #3b82f6; } /* ä¸€èˆ¬ */
        .level-3 { background: #d1fae5; color: #10b981; } /* ç¨ç†Ÿ */
        .level-4 { background: #fef3c7; color: #f59e0b; } /* ç†Ÿæ‚‰ */
        .level-5 { background: #fee2e2; color: #ef4444; } /* çƒ­æƒ… */
        .level-6 { background: #fce7f3; color: #ec4899; } /* äº²å¯† */
        .level-7 { background: #ede9fe; color: #8b5cf6; } /* å–œæ¬¢ */
        .level-8 { background: linear-gradient(135deg, #fda4af, #f472b6); color: white; } /* å–œæ¬¢+ */
        .level-9 { background: linear-gradient(135deg, #f472b6, #ec4899); color: white; } /* çˆ±æ…• */
        .level-10 { background: linear-gradient(135deg, #ec4899, #db2777); color: white; } /* æ·±çˆ± */
        .level-11 { background: linear-gradient(135deg, #db2777, #be185d); color: white; } /* æŒšçˆ± */
        .level-12 { background: linear-gradient(135deg, #be185d, #9f1239); color: white; } /* å‘½è¿ */
        .level-13 { background: linear-gradient(135deg, #9f1239, #881337, #fbbf24); color: white; font-weight: bold; } /* æ°¸æ’ */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="max-w-6xl mx-auto mb-8">
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-pink-400 to-rose-300 flex items-center justify-center text-3xl shadow-lg">
                    ğŸ’—
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Yuki å¥½æ„Ÿåº¦ç®¡ç†</h1>
                    <p class="text-gray-500 text-sm">æŸ¥çœ‹å’Œè°ƒæ•´ç”¨æˆ·ä¸ Yuki çš„äº²å¯†åº¦</p>
                </div>
            </div>
            <!-- å¯¼èˆªæŒ‰é’® -->
            <nav class="flex gap-2" id="navLinks">
                <a href="/admin" class="nav-link text-gray-600">ğŸ“Š ä»ªè¡¨ç›˜</a>
                <a href="/admin/affection" class="nav-link active">ğŸ’— å¥½æ„Ÿåº¦</a>
                <a href="/admin/db" class="nav-link">ğŸ—‚ æ•°æ®åº“</a>
            </nav>
        </div>
    </header>

    <main class="max-w-6xl mx-auto">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card p-6">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">ğŸ‘¥</span>
                    <span class="text-gray-600 font-medium">æ€»ç”¨æˆ·æ•°</span>
                </div>
                <div class="stat-value" id="total_users">0</div>
                <div class="text-sm text-gray-400 mt-2">æœ‰å¥½æ„Ÿåº¦è®°å½•çš„ç”¨æˆ·</div>
            </div>

            <div class="card p-6">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">ğŸ’•</span>
                    <span class="text-gray-600 font-medium">å¹³å‡å¥½æ„Ÿåº¦</span>
                </div>
                <div class="stat-value" id="avg_score">0.0</div>
                <div class="text-sm text-gray-400 mt-2">æ‰€æœ‰ç”¨æˆ·å¹³å‡åˆ†</div>
            </div>

            <div class="card p-6">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">â­</span>
                    <span class="text-gray-600 font-medium">æ»¡çº§ç”¨æˆ·</span>
                </div>
                <div class="stat-value" id="max_level_count">0</div>
                <div class="text-sm text-gray-400 mt-2">è¾¾åˆ°ã€Œæ°¸æ’ã€çš„ç”¨æˆ·</div>
            </div>

            <div class="card p-6">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">ğŸŒŸ</span>
                    <span class="text-gray-600 font-medium">é«˜å¥½æ„Ÿç”¨æˆ·</span>
                </div>
                <div class="stat-value" id="high_level_count">0</div>
                <div class="text-sm text-gray-400 mt-2">ç­‰çº§ â‰¥ 7ï¼ˆå–œæ¬¢ï¼‰</div>
            </div>
        </div>

        <!-- å›¾è¡¨å’Œåˆ—è¡¨ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- ç­‰çº§åˆ†å¸ƒå›¾ -->
            <div class="card p-6">
                <h3 class="text-gray-700 font-semibold mb-4">ğŸ“Š ç­‰çº§åˆ†å¸ƒ</h3>
                <canvas id="levelChart" height="250"></canvas>
            </div>

            <!-- ç”¨æˆ·åˆ—è¡¨ -->
            <div class="card p-6 lg:col-span-2">
                <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
                    <h3 class="text-gray-700 font-semibold">ğŸ‘¤ ç”¨æˆ·åˆ—è¡¨</h3>
                    <div class="flex gap-2 flex-wrap">
                        <select id="levelFilter" class="px-3 py-1.5 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
                            <option value="">å…¨éƒ¨ç­‰çº§</option>
                            <option value="-2">-2 - è®¨åŒ</option>
                            <option value="-1">-1 - å·®åŠ²</option>
                            <option value="0">0 - ä¸èµ·çœ¼</option>
                            <option value="1">1 - é™Œç”Ÿ</option>
                            <option value="2">2 - ä¸€èˆ¬</option>
                            <option value="3">3 - ç¨ç†Ÿ</option>
                            <option value="4">4 - ç†Ÿæ‚‰</option>
                            <option value="5">5 - çƒ­æƒ…</option>
                            <option value="6">6 - äº²å¯†</option>
                            <option value="7">7 - å–œæ¬¢</option>
                            <option value="8">8 - å–œæ¬¢+</option>
                            <option value="9">9 - çˆ±æ…•</option>
                            <option value="10">10 - æ·±çˆ±</option>
                            <option value="11">11 - æŒšçˆ±</option>
                            <option value="12">12 - å‘½è¿</option>
                            <option value="13">13 - æ°¸æ’</option>
                        </select>
                        <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ·ID..."
                               class="px-3 py-1.5 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
                        <button onclick="loadList(1)" class="px-3 py-1.5 bg-pink-500 text-white rounded-lg text-sm hover:bg-pink-600">
                            ğŸ” æœç´¢
                        </button>
                    </div>
                </div>

                <!-- è¡¨æ ¼ -->
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-2">ç”¨æˆ· ID</th>
                                <th class="text-left py-3 px-2">å¥½æ„Ÿåº¦</th>
                                <th class="text-left py-3 px-2">ç­‰çº§</th>
                                <th class="text-left py-3 px-2">äº’åŠ¨æ¬¡æ•°</th>
                                <th class="text-left py-3 px-2">æœ€è¿‘äº’åŠ¨</th>
                                <th class="text-left py-3 px-2">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr><td colspan="6" class="text-center py-8 text-gray-400">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µ -->
                <div class="flex items-center justify-between mt-4 text-sm text-gray-500">
                    <span id="pageInfo">ç¬¬ 1 é¡µï¼Œå…± 0 æ¡</span>
                    <div class="flex gap-2">
                        <button onclick="prevPage()" id="prevBtn" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50">ä¸Šä¸€é¡µ</button>
                        <button onclick="nextPage()" id="nextBtn" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-gray-400 text-sm mt-8 pb-4">
            <span class="pulse">ğŸŸ¢</span> å®æ—¶æ›´æ–°ä¸­ Â· æœ€åæ›´æ–°: <span id="last_update">-</span>
        </footer>
    </main>

    <!-- ä¿®æ”¹å¥½æ„Ÿåº¦å¼¹çª— -->
    <div id="editModal" class="modal">
        <div class="card p-6 w-96">
            <h3 class="text-lg font-semibold mb-4">âœï¸ ä¿®æ”¹å¥½æ„Ÿåº¦</h3>
            <div class="mb-4">
                <label class="block text-sm text-gray-600 mb-1">ç”¨æˆ· ID</label>
                <input type="text" id="editUserId" readonly class="w-full px-3 py-2 border rounded-lg bg-gray-50">
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-600 mb-1">å½“å‰åˆ†æ•°</label>
                <input type="text" id="editCurrentScore" readonly class="w-full px-3 py-2 border rounded-lg bg-gray-50">
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-600 mb-1">æ–°åˆ†æ•° (0.1 - 10.0)</label>
                <input type="number" id="editNewScore" min="0.1" max="10" step="0.1"
                       class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
            </div>
            <div class="flex gap-2 justify-end">
                <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100">å–æ¶ˆ</button>
                <button onclick="saveScore()" class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token') || '';

        let levelChart = null;
        let currentPage = 1;
        let totalItems = 0;
        const pageSize = 15;

        const levelNames = {
            '-2': 'è®¨åŒ', '-1': 'å·®åŠ²', '0': 'ä¸èµ·çœ¼',
            '1': 'é™Œç”Ÿ', '2': 'ä¸€èˆ¬', '3': 'ç¨ç†Ÿ', '4': 'ç†Ÿæ‚‰',
            '5': 'çƒ­æƒ…', '6': 'äº²å¯†', '7': 'å–œæ¬¢', '8': 'å–œæ¬¢+',
            '9': 'çˆ±æ…•', '10': 'æ·±çˆ±', '11': 'æŒšçˆ±', '12': 'å‘½è¿', '13': 'æ°¸æ’'
        };

        // åŠ è½½æ€»è§ˆæ•°æ®
        async function loadOverview() {
            try {
                const res = await fetch(`/admin/api/affection/overview?token=${token}`);
                const result = await res.json();
                if (!result.success) return;

                const data = result.data;
                document.getElementById('total_users').textContent = data.total_users;
                document.getElementById('avg_score').textContent = data.avg_score.toFixed(1);
                document.getElementById('max_level_count').textContent = data.level_counts[13] || 0;

                // é«˜å¥½æ„Ÿç”¨æˆ·ï¼ˆç­‰çº§ >= 7ï¼‰
                let highCount = 0;
                for (let i = 7; i <= 13; i++) {
                    highCount += (data.level_counts[i] || 0);
                }
                document.getElementById('high_level_count').textContent = highCount;

                // æ›´æ–°å›¾è¡¨
                updateLevelChart(data.level_counts);
                document.getElementById('last_update').textContent = new Date().toLocaleTimeString();
            } catch (e) {
                console.error('Failed to load overview:', e);
            }
        }

        // åˆå§‹åŒ–ç­‰çº§åˆ†å¸ƒå›¾
        function initLevelChart() {
            const ctx = document.getElementById('levelChart').getContext('2d');
            levelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(levelNames),
                    datasets: [{
                        label: 'ç”¨æˆ·æ•°',
                        data: Array(16).fill(0), // -2 åˆ° 13 å…± 16 ä¸ªç­‰çº§
                        backgroundColor: [
                            '#1f2937', '#374151', '#6b7280', '#9ca3af', // è®¨åŒåˆ°é™Œç”Ÿ
                            '#dbeafe', '#d1fae5', '#fef3c7', '#fee2e2', // ä¸€èˆ¬åˆ°çƒ­æƒ…
                            '#fce7f3', '#ede9fe', '#f472b6', '#ec4899', // äº²å¯†åˆ°çˆ±æ…•
                            '#db2777', '#be185d', '#9f1239', '#881337'  // æ·±çˆ±åˆ°æ°¸æ’
                        ],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        function updateLevelChart(levelCounts) {
            const data = [];
            for (let i = -2; i <= 13; i++) {
                data.push(levelCounts[i] || 0);
            }
            levelChart.data.datasets[0].data = data;
            levelChart.update();
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadList(page = 1) {
            currentPage = page;
            const level = document.getElementById('levelFilter').value;
            const keyword = document.getElementById('searchInput').value;

            let url = `/admin/api/affection/list?token=${token}&page=${page}&page_size=${pageSize}`;
            if (level) url += `&level=${level}`;
            if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;

            try {
                const res = await fetch(url);
                const result = await res.json();
                if (!result.success) return;

                const data = result.data;
                totalItems = data.total;
                renderTable(data.items);
                updatePagination();
            } catch (e) {
                console.error('Failed to load list:', e);
            }
        }

        function renderTable(items) {
            const tbody = document.getElementById('userTableBody');
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = items.map(item => `
                <tr class="border-b hover:bg-pink-50/50">
                    <td class="py-3 px-2 font-mono">${item.user_id}</td>
                    <td class="py-3 px-2 font-semibold text-pink-600">${item.score}</td>
                    <td class="py-3 px-2">
                        <span class="level-badge level-${item.level}">${item.level_name}</span>
                    </td>
                    <td class="py-3 px-2">${item.total_interactions}</td>
                    <td class="py-3 px-2 text-gray-500">${formatTime(item.last_interact_at)}</td>
                    <td class="py-3 px-2">
                        <button onclick="openEditModal('${item.user_id}', ${item.score})"
                                class="text-pink-500 hover:text-pink-700">âœï¸ è°ƒæ•´</button>
                    </td>
                </tr>
            `).join('');
        }

        function formatTime(isoStr) {
            if (!isoStr) return '-';
            const d = new Date(isoStr);
            return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
        }

        function updatePagination() {
            const totalPages = Math.ceil(totalItems / pageSize);
            document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalItems} æ¡`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        function prevPage() { if (currentPage > 1) loadList(currentPage - 1); }
        function nextPage() { loadList(currentPage + 1); }

        // ç¼–è¾‘å¼¹çª—
        function openEditModal(userId, score) {
            document.getElementById('editUserId').value = userId;
            document.getElementById('editCurrentScore').value = score;
            document.getElementById('editNewScore').value = score;
            document.getElementById('editModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        async function saveScore() {
            const userId = document.getElementById('editUserId').value;
            const newScore = parseFloat(document.getElementById('editNewScore').value);

            if (isNaN(newScore) || newScore < 0.1 || newScore > 10) {
                alert('åˆ†æ•°å¿…é¡»åœ¨ 0.1 åˆ° 10 ä¹‹é—´');
                return;
            }

            try {
                const res = await fetch(`/admin/api/affection/update?token=${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, score: newScore })
                });
                const result = await res.json();
                if (result.success) {
                    closeModal();
                    loadOverview();
                    loadList(currentPage);
                } else {
                    alert('ä¿®æ”¹å¤±è´¥: ' + result.error);
                }
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥');
            }
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            initLevelChart();
            loadOverview();
            loadList(1);

            // ç»™å¯¼èˆªé“¾æ¥æ·»åŠ  token å‚æ•°
            if (token) {
                document.querySelectorAll('#navLinks a').forEach(a => {
                    a.href += '?token=' + token;
                });
            }

            setInterval(loadOverview, 30000);
        });

        // å›è½¦æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') loadList(1);
        });
    </script>
</body>
</html>
